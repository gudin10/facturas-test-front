<form [formGroup]="facturaForm">
  <mat-card class="p-4">
    <mat-card-header>
      <mat-card-title>Creaci√≥n de Factura</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="flex gap-4 mb-4">
        <mat-form-field class="w-1/2" appearance="outline">
          <mat-label>Cliente</mat-label>
          <mat-select formControlName="idCliente">
            <mat-option *ngFor="let c of clientes" [value]="c.id">{{ c.razonSocial }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="w-1/2" appearance="outline">
          <mat-label>N√∫mero de Factura</mat-label>
          <input matInput formControlName="numeroFactura" type="number">
        </mat-form-field>
      </div>

      <button mat-raised-button color="primary" type="button" (click)="addDetalle()">Agregar producto</button>
      <button mat-raised-button color="warn" type="button" (click)="resetForm()">Nuevo</button>

      <!-- üëá IMPORTANTE: formArrayName para que funcione -->
      <div formArrayName="detalles">
        <table mat-table [dataSource]="detalles.controls" class="w-full mt-4">

          <ng-container matColumnDef="producto">
            <th mat-header-cell *matHeaderCellDef>Producto</th>
            <td mat-cell *matCellDef="let row; let i=index" [formGroupName]="i">
              <mat-select formControlName="idProducto" (selectionChange)="onSelectProducto(i)">
                <mat-option *ngFor="let p of productos" [value]="p.id">{{ p.nombreProducto }}</mat-option>
              </mat-select>
            </td>
          </ng-container>

          <ng-container matColumnDef="precio">
            <th mat-header-cell *matHeaderCellDef>Precio Unitario</th>
            <td mat-cell *matCellDef="let row; let i=index" [formGroupName]="i">
              <input matInput formControlName="precioUnitarioProducto" readonly>
            </td>
          </ng-container>

          <ng-container matColumnDef="cantidad">
            <th mat-header-cell *matHeaderCellDef>Cantidad</th>
            <td mat-cell *matCellDef="let row; let i=index" [formGroupName]="i">
              <input matInput type="number" formControlName="cantidadDeProducto" (input)="recalcularLinea(i)">
            </td>
          </ng-container>

          <ng-container matColumnDef="imagen">
            <th mat-header-cell *matHeaderCellDef>Imagen</th>
            <td mat-cell *matCellDef="let row; let i=index" [formGroupName]="i">
              <img *ngIf="row.value.imagen" [src]="'data:image/png;base64,'+row.value.imagen" width="40">
            </td>
          </ng-container>

          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Totales</th>
            <td mat-cell *matCellDef="let row; let i=index" [formGroupName]="i">
              {{ row.value.subtotalProducto | number:'1.2-2' }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <div class="mt-4 text-right">
        <p>Sub total: {{ subtotal | number:'1.2-2' }}</p>
        <p>Impuestos (19%): {{ impuestos | number:'1.2-2' }}</p>
        <p><strong>Total: {{ total | number:'1.2-2' }}</strong></p>
      </div>

      <div class="mt-4">
        <button mat-raised-button color="accent" type="button" (click)="guardar()">Guardar</button>
      </div>
    </mat-card-content>
  </mat-card>
</form>
